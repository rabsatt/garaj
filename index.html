<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Garage Organizer</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f8fafc;
      min-height: 100vh;
    }
    /* Header */
    .header {
      background-color: #1e293b;
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }
    .header-subtitle {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 4px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }
    .sign-out-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      padding: 40px 20px;
      text-align: center;
    }
    .login-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    .login-title {
      font-size: 24px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }
    .login-subtitle {
      font-size: 16px;
      color: #64748b;
      margin-bottom: 32px;
    }
    .google-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      border: 2px solid #e2e8f0;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .google-btn:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .google-btn img {
      width: 24px;
      height: 24px;
    }
    /* Filter Chips */
    .filter-bar {
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      overflow-x: auto;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      -webkit-overflow-scrolling: touch;
    }
    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      background-color: #e2e8f0;
      color: #475569;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .filter-chip.active {
      background-color: #3b82f6;
      color: white;
    }
    /* Status Filter */
    .status-bar {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      background: #f1f5f9;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .status-chip {
      padding: 6px 12px;
      border-radius: 16px;
      border: 2px solid transparent;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .status-chip.to-sort { background: #f1f5f9; color: #64748b; }
    .status-chip.keep { background: #dcfce7; color: #166534; }
    .status-chip.sell { background: #dbeafe; color: #1e40af; }
    .status-chip.donate { background: #fae8ff; color: #86198f; }
    .status-chip.dump { background: #fee2e2; color: #991b1b; }
    .status-chip.active {
      border-color: #1e293b;
    }
    /* Items List */
    .items-container {
      padding: 16px 20px;
      padding-bottom: 120px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .item-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .item-content {
      display: flex;
      gap: 12px;
    }
    .item-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      flex-shrink: 0;
    }
    .item-details {
      flex: 1;
    }
    .item-name {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      cursor: pointer;
    }
    .item-delete {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      opacity: 0.4;
      padding: 4px;
    }
    .item-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .tag.category { background: #dbeafe; color: #1e40af; }
    .tag.location { background: #fef3c7; color: #92400e; }
    .tag.value { background: #dcfce7; color: #166534; }
    /* Expanded Image */
    .expanded-section {
      margin-top: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }
    .expanded-image {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .expanded-detail {
      font-size: 14px;
      color: #475569;
      margin-bottom: 8px;
    }
    .expanded-detail strong {
      color: #1e293b;
    }
    /* Decision Buttons */
    .decision-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .decision-btn {
      flex: 1;
      min-width: 70px;
      padding: 10px 8px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    .decision-btn.selected {
      border-width: 2px;
    }
    .decision-btn.keep { color: #166534; }
    .decision-btn.keep.selected { background: #dcfce7; border-color: #166534; }
    .decision-btn.sell { color: #1e40af; }
    .decision-btn.sell.selected { background: #dbeafe; border-color: #1e40af; }
    .decision-btn.donate { color: #86198f; }
    .decision-btn.donate.selected { background: #fae8ff; border-color: #86198f; }
    .decision-btn.dump { color: #991b1b; }
    .decision-btn.dump.selected { background: #fee2e2; border-color: #991b1b; }
    /* Destination Input */
    .destination-input {
      margin-top: 10px;
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #dcfce7;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }
    .destination-input:focus {
      border-color: #166534;
    }
    /* Add Button */
    .add-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background-color: #3b82f6;
      color: white;
      border: none;
      font-size: 32px;
      font-weight: 300;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 150;
    }
    .modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      padding: 24px 20px 40px;
      z-index: 200;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
    }
    /* Photo Upload */
    .photo-upload {
      width: 100%;
      padding: 32px 16px;
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 16px;
    }
    .photo-upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .photo-upload-text {
      font-size: 16px;
      color: #64748b;
    }
    .photo-upload-hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    /* AI Identification */
    .ai-results {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px solid #7dd3fc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .ai-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-weight: 600;
      color: #0369a1;
    }
    .ai-suggestion {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .ai-suggestion:hover {
      border-color: #3b82f6;
    }
    .ai-suggestion-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .ai-suggestion-details {
      font-size: 13px;
      color: #64748b;
    }
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #0369a1;
      font-size: 14px;
    }
    .ai-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #7dd3fc;
      border-top-color: #0369a1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .ai-error {
      color: #dc2626;
      font-size: 13px;
      padding: 8px;
      background: #fef2f2;
      border-radius: 8px;
    }
    .ai-skip {
      font-size: 13px;
      color: #64748b;
      text-align: center;
      cursor: pointer;
      padding: 8px;
    }
    .ai-skip:hover {
      color: #3b82f6;
    }
    .photo-preview-container {
      position: relative;
      margin-bottom: 16px;
    }
    .photo-preview {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }
    .photo-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row .form-group {
      flex: 1;
    }
    .form-row .form-group.small {
      flex: 0 0 120px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #475569;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .form-textarea {
      resize: none;
      min-height: 60px;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: #3b82f6;
    }
    .submit-btn {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 8px;
    }
    .submit-btn:disabled {
      background-color: #cbd5e1;
      cursor: not-allowed;
    }
    .form-hint {
      text-align: center;
      font-size: 13px;
      color: #94a3b8;
      margin-top: 8px;
    }
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      color: #64748b;
    }
    /* Progress Stats */
    .progress-bar {
      background: white;
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #64748b;
      margin-bottom: 8px;
    }
    .progress-track {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    .progress-segment {
      height: 100%;
      transition: width 0.3s;
    }
    .progress-segment.keep { background: #22c55e; }
    .progress-segment.sell { background: #3b82f6; }
    .progress-segment.donate { background: #d946ef; }
    .progress-segment.dump { background: #ef4444; }
    .progress-legend {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .legend-item {
      font-size: 12px;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .legend-dot.keep { background: #22c55e; }
    .legend-dot.sell { background: #3b82f6; }
    .legend-dot.donate { background: #d946ef; }
    .legend-dot.dump { background: #ef4444; }
    .sell-value {
      color: #1e40af;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;">

  <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyDu8GnqAj_BQ7UddUA7GYwr70wbM6NXTic",
      authDomain: "garaj-9f6ac.firebaseapp.com",
      projectId: "garaj-9f6ac",
      storageBucket: "garaj-9f6ac.firebasestorage.app",
      messagingSenderId: "250262045467",
      appId: "1:250262045467:web:53eec3243853c2932f89be"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ============================================
    // IMAGE COMPRESSION
    // ============================================
    const MAX_IMAGE_WIDTH = 800;
    const MAX_IMAGE_HEIGHT = 800;
    const JPEG_QUALITY = 0.7;

    function compressImage(file) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
          let { width, height } = img;

          if (width > height) {
            if (width > MAX_IMAGE_WIDTH) {
              height = (height * MAX_IMAGE_WIDTH) / width;
              width = MAX_IMAGE_WIDTH;
            }
          } else {
            if (height > MAX_IMAGE_HEIGHT) {
              width = (width * MAX_IMAGE_HEIGHT) / height;
              height = MAX_IMAGE_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(
            (blob) => resolve(blob),
            'image/jpeg',
            JPEG_QUALITY
          );
        };

        img.src = URL.createObjectURL(file);
      });
    }

    // ============================================
    // AI IDENTIFICATION (Google Cloud Vision)
    // ============================================
    async function identifyItemWithAI(imageBlob) {
      if (!GOOGLE_VISION_API_KEY) {
        console.log('No API key configured, skipping AI identification');
        return null;
      }

      try {
        // Convert blob to base64
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64Data = reader.result.split(',')[1];
            resolve(base64Data);
          };
          reader.readAsDataURL(imageBlob);
        });

        // Call Google Cloud Vision API
        const response = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requests: [{
                image: { content: base64 },
                features: [
                  { type: 'LABEL_DETECTION', maxResults: 10 },
                  { type: 'OBJECT_LOCALIZATION', maxResults: 5 },
                  { type: 'WEB_DETECTION', maxResults: 5 }
                ]
              }]
            })
          }
        );

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const result = data.responses[0];

        // Process the results
        const suggestions = [];
        const seenNames = new Set();

        // Get object names from object localization (most specific)
        if (result.localizedObjectAnnotations) {
          result.localizedObjectAnnotations.forEach(obj => {
            const name = obj.name;
            if (!seenNames.has(name.toLowerCase())) {
              seenNames.add(name.toLowerCase());
              suggestions.push({
                name: name,
                confidence: Math.round(obj.score * 100),
                category: mapToCategory(name)
              });
            }
          });
        }

        // Get web entities (good for product identification)
        if (result.webDetection && result.webDetection.webEntities) {
          result.webDetection.webEntities.slice(0, 3).forEach(entity => {
            if (entity.description && entity.score > 0.5 && !seenNames.has(entity.description.toLowerCase())) {
              seenNames.add(entity.description.toLowerCase());
              suggestions.push({
                name: entity.description,
                confidence: Math.round(entity.score * 100),
                category: mapToCategory(entity.description)
              });
            }
          });
        }

        // Fallback to labels if no objects detected
        if (suggestions.length === 0 && result.labelAnnotations) {
          result.labelAnnotations.slice(0, 3).forEach(label => {
            if (!seenNames.has(label.description.toLowerCase())) {
              seenNames.add(label.description.toLowerCase());
              suggestions.push({
                name: label.description,
                confidence: Math.round(label.score * 100),
                category: mapToCategory(label.description)
              });
            }
          });
        }

        return suggestions.slice(0, 3);

      } catch (error) {
        console.error('AI identification error:', error);
        throw error;
      }
    }

    // Map detected item to our categories
    function mapToCategory(itemName) {
      const name = itemName.toLowerCase();

      // Kitchen
      if (/blender|mixer|pot|pan|kettle|toaster|microwave|dish|plate|bowl|cup|mug|utensil|knife|fork|spoon|cookware|kitchen|food|appliance/.test(name)) {
        return 'Kitchen Items';
      }

      // Lamps & Lighting
      if (/lamp|light|bulb|chandelier|lantern|fixture|lighting/.test(name)) {
        return 'Lamps & Lighting';
      }

      // Office Supplies
      if (/desk|office|pen|pencil|stapler|paper|notebook|binder|computer|monitor|keyboard|mouse|printer|chair/.test(name)) {
        return 'Office Supplies';
      }

      // Furniture
      if (/furniture|table|chair|sofa|couch|bed|dresser|cabinet|shelf|bookcase|wardrobe|drawer/.test(name)) {
        return 'Furniture';
      }

      // Sporting Goods
      if (/sport|ball|bat|racket|golf|tennis|bike|bicycle|skateboard|ski|exercise|fitness|gym|weight/.test(name)) {
        return 'Sporting Goods';
      }

      // Electronics
      if (/electronic|tv|television|speaker|headphone|phone|tablet|camera|gaming|console|video|audio|stereo|radio/.test(name)) {
        return 'Electronics';
      }

      // Tools
      if (/tool|hammer|screwdriver|drill|saw|wrench|plier|hardware|garage/.test(name)) {
        return 'Tools';
      }

      // Decor
      if (/decor|art|painting|frame|vase|sculpture|mirror|rug|carpet|curtain|pillow|candle/.test(name)) {
        return 'Decor';
      }

      // Clothing
      if (/cloth|shirt|pants|dress|shoe|jacket|coat|hat|clothing|apparel|fashion|wear/.test(name)) {
        return 'Clothing';
      }

      // Books & Media
      if (/book|magazine|dvd|cd|vinyl|record|media|movie|music/.test(name)) {
        return 'Books & Media';
      }

      // Holiday Items
      if (/christmas|halloween|easter|holiday|decoration|ornament|seasonal/.test(name)) {
        return 'Holiday Items';
      }

      // Outdoor/Garden
      if (/outdoor|garden|plant|pot|lawn|patio|grill|bbq|hose|rake|shovel/.test(name)) {
        return 'Outdoor/Garden';
      }

      return 'Other';
    }

    // ============================================
    // APP STATE
    // ============================================
    const CATEGORIES = [
      'Kitchen Items', 'Lamps & Lighting', 'Office Supplies', 'Furniture',
      'Sporting Goods', 'Electronics', 'Tools', 'Decor', 'Clothing',
      'Books & Media', 'Holiday Items', 'Outdoor/Garden', 'Other'
    ];

    const STATUSES = ['To Sort', 'Keep', 'Sell', 'Donate', 'Dump'];

    // ============================================
    // GOOGLE CLOUD VISION API KEY
    // ============================================
    // To use AI identification, add your Google Cloud Vision API key here
    // Get one at: https://console.cloud.google.com/apis/credentials
    // Make sure to enable the Cloud Vision API for your project
    const GOOGLE_VISION_API_KEY = 'AIzaSyCMSZwyLOuJYw1i1df6asrIbudpOnJG0n8'; // Add your API key here

    let state = {
      user: null,
      items: [],
      loading: true,
      showForm: false,
      categoryFilter: 'all',
      statusFilter: 'all',
      expandedItem: null,
      newItem: {
        name: '',
        category: 'Kitchen Items',
        location: '',
        condition: '',
        estimatedValue: '',
        description: ''
      },
      selectedImage: null,
      imagePreview: null,
      // AI identification state
      aiLoading: false,
      aiError: null,
      aiSuggestions: null
    };

    // ============================================
    // FIRESTORE OPERATIONS
    // ============================================
    function getItemsCollection() {
      return db.collection('users').doc(state.user.uid).collection('items');
    }

    async function loadItems() {
      if (!state.user) return;
      try {
        const snapshot = await getItemsCollection().orderBy('createdAt', 'desc').get();
        state.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      } catch (error) {
        console.error('Error loading items:', error);
      }
    }

    async function addItem(item) {
      if (!state.user) return;
      try {
        let imageUrl = null;

        // Upload image if selected
        if (state.selectedImage) {
          const imageId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          const imageRef = storage.ref(`users/${state.user.uid}/items/${imageId}.jpg`);
          await imageRef.put(state.selectedImage);
          imageUrl = await imageRef.getDownloadURL();
        }

        const docRef = await getItemsCollection().add({
          ...item,
          imageUrl: imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        state.items.unshift({ id: docRef.id, ...item, imageUrl: imageUrl, createdAt: new Date() });
        render();
      } catch (error) {
        console.error('Error adding item:', error);
        alert('Failed to add item: ' + error.message);
      }
    }

    async function updateItem(id, updates) {
      if (!state.user) return;
      try {
        await getItemsCollection().doc(id).update(updates);
        const index = state.items.findIndex(item => item.id === id);
        if (index !== -1) {
          state.items[index] = { ...state.items[index], ...updates };
          render();
        }
      } catch (error) {
        console.error('Error updating item:', error);
      }
    }

    async function deleteItem(id) {
      if (!state.user) return;
      try {
        // Find item to check for image
        const item = state.items.find(i => i.id === id);

        // Delete image from storage if exists
        if (item && item.imageUrl) {
          try {
            const imageRef = storage.refFromURL(item.imageUrl);
            await imageRef.delete();
          } catch (e) {
            console.log('Image already deleted or not found');
          }
        }

        await getItemsCollection().doc(id).delete();
        state.items = state.items.filter(item => item.id !== id);
        render();
      } catch (error) {
        console.error('Error deleting item:', error);
      }
    }

    // ============================================
    // AUTH
    // ============================================
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => {
        console.error('Sign in error:', error);
        alert('Sign in failed: ' + error.message);
      });
    }

    function signOut() {
      auth.signOut();
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function render() {
      const app = document.getElementById('app');

      if (state.loading) {
        app.innerHTML = '<div class="loading">Loading...</div>';
        return;
      }

      if (!state.user) {
        app.innerHTML = renderLoginScreen();
        attachLoginEvents();
        return;
      }

      app.innerHTML = renderHeader() + renderProgressBar() + renderFilters() + renderStatusFilters() + renderItems();

      if (state.showForm) {
        app.innerHTML += renderModal();
      } else {
        app.innerHTML += '<button class="add-btn" onclick="openForm()">+</button>';
      }

      attachEvents();
    }

    function renderLoginScreen() {
      return `
        <div class="login-screen">
          <div class="login-icon">üì¶</div>
          <h2 class="login-title">Garage Organizer</h2>
          <p class="login-subtitle">Track and organize your post-move inventory</p>
          <button class="google-btn" id="google-signin">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            Sign in with Google
          </button>
        </div>
      `;
    }

    function renderHeader() {
      return `
        <div class="header">
          <div>
            <h1>Garage Organizer</h1>
            <p class="header-subtitle">${state.items.length} items ‚Ä¢ ${state.items.filter(i => i.status === 'To Sort').length} to sort</p>
          </div>
          <div class="user-info">
            <img src="${state.user.photoURL || ''}" class="user-avatar" alt="">
            <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
          </div>
        </div>
      `;
    }

    function renderProgressBar() {
      const total = state.items.length;
      if (total === 0) return '';

      const counts = {
        keep: state.items.filter(i => i.status === 'Keep').length,
        sell: state.items.filter(i => i.status === 'Sell').length,
        donate: state.items.filter(i => i.status === 'Donate').length,
        dump: state.items.filter(i => i.status === 'Dump').length
      };

      const sorted = counts.keep + counts.sell + counts.donate + counts.dump;

      // Calculate total estimated value for sell items
      const sellValue = state.items
        .filter(i => i.status === 'Sell' && i.estimatedValue)
        .reduce((sum, i) => sum + (parseFloat(i.estimatedValue) || 0), 0);

      return `
        <div class="progress-bar">
          <div class="progress-stats">
            <span>Sorting Progress</span>
            <span>${sorted} of ${total} decided</span>
          </div>
          <div class="progress-track">
            <div class="progress-segment keep" style="width: ${counts.keep / total * 100}%"></div>
            <div class="progress-segment sell" style="width: ${counts.sell / total * 100}%"></div>
            <div class="progress-segment donate" style="width: ${counts.donate / total * 100}%"></div>
            <div class="progress-segment dump" style="width: ${counts.dump / total * 100}%"></div>
          </div>
          <div class="progress-legend">
            <span class="legend-item"><span class="legend-dot keep"></span> Keep: ${counts.keep}</span>
            <span class="legend-item"><span class="legend-dot sell"></span> Sell: ${counts.sell}${sellValue > 0 ? ` <span class="sell-value">(~$${sellValue})</span>` : ''}</span>
            <span class="legend-item"><span class="legend-dot donate"></span> Donate: ${counts.donate}</span>
            <span class="legend-item"><span class="legend-dot dump"></span> Dump: ${counts.dump}</span>
          </div>
        </div>
      `;
    }

    function renderFilters() {
      const categoryCounts = {};
      state.items.forEach(item => {
        categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1;
      });

      let chips = `<button class="filter-chip ${state.categoryFilter === 'all' ? 'active' : ''}" data-category="all">All (${state.items.length})</button>`;

      CATEGORIES.forEach(cat => {
        if (categoryCounts[cat]) {
          chips += `<button class="filter-chip ${state.categoryFilter === cat ? 'active' : ''}" data-category="${cat}">${cat.split(' ')[0]} (${categoryCounts[cat]})</button>`;
        }
      });

      return `<div class="filter-bar">${chips}</div>`;
    }

    function renderStatusFilters() {
      const statusCounts = { all: state.items.length };
      STATUSES.forEach(s => {
        statusCounts[s] = state.items.filter(i => i.status === s).length;
      });

      return `
        <div class="status-bar">
          <button class="status-chip ${state.statusFilter === 'all' ? 'active' : ''}" data-status="all">All</button>
          <button class="status-chip to-sort ${state.statusFilter === 'To Sort' ? 'active' : ''}" data-status="To Sort">üì¶ To Sort (${statusCounts['To Sort'] || 0})</button>
          <button class="status-chip keep ${state.statusFilter === 'Keep' ? 'active' : ''}" data-status="Keep">‚úì Keep (${statusCounts['Keep'] || 0})</button>
          <button class="status-chip sell ${state.statusFilter === 'Sell' ? 'active' : ''}" data-status="Sell">üí∞ Sell (${statusCounts['Sell'] || 0})</button>
          <button class="status-chip donate ${state.statusFilter === 'Donate' ? 'active' : ''}" data-status="Donate">üéÅ Donate (${statusCounts['Donate'] || 0})</button>
          <button class="status-chip dump ${state.statusFilter === 'Dump' ? 'active' : ''}" data-status="Dump">üóëÔ∏è Dump (${statusCounts['Dump'] || 0})</button>
        </div>
      `;
    }

    function renderItems() {
      let filtered = state.items;

      if (state.categoryFilter !== 'all') {
        filtered = filtered.filter(item => item.category === state.categoryFilter);
      }
      if (state.statusFilter !== 'all') {
        filtered = filtered.filter(item => item.status === state.statusFilter);
      }

      if (filtered.length === 0) {
        return `
          <div class="items-container">
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <p>No items ${state.categoryFilter !== 'all' || state.statusFilter !== 'all' ? 'match your filters' : 'yet'}</p>
              <p style="font-size: 14px; margin-top: 8px;">Tap the + button to start adding</p>
            </div>
          </div>
        `;
      }

      const itemCards = filtered.map(item => {
        const isExpanded = state.expandedItem === item.id;
        return `
        <div class="item-card" data-id="${item.id}">
          <div class="item-content">
            ${item.imageUrl ? `<img src="${item.imageUrl}" class="item-thumbnail" data-expand="${item.id}" alt="">` : ''}
            <div class="item-details">
              <div class="item-header">
                <h3 class="item-name" data-expand="${item.id}">${escapeHtml(item.name)}</h3>
                <button class="item-delete" data-delete="${item.id}">√ó</button>
              </div>
              <div class="item-tags">
                <span class="tag category">${escapeHtml(item.category)}</span>
                <span class="tag location">üìç ${escapeHtml(item.location || 'Unassigned')}</span>
                ${item.estimatedValue ? `<span class="tag value">~$${escapeHtml(item.estimatedValue)}</span>` : ''}
                ${item.destination ? `<span class="tag value">‚Üí ${escapeHtml(item.destination)}</span>` : ''}
              </div>
            </div>
          </div>

          ${isExpanded ? `
            <div class="expanded-section">
              ${item.imageUrl ? `<img src="${item.imageUrl}" class="expanded-image" alt="">` : ''}
              ${item.condition ? `<p class="expanded-detail"><strong>Condition:</strong> ${escapeHtml(item.condition)}</p>` : ''}
              ${item.description ? `<p class="expanded-detail"><strong>Description:</strong> ${escapeHtml(item.description)}</p>` : ''}
              ${item.estimatedValue ? `<p class="expanded-detail"><strong>Estimated Value:</strong> $${escapeHtml(item.estimatedValue)}</p>` : ''}
            </div>
          ` : ''}

          <div class="decision-buttons">
            <button class="decision-btn keep ${item.status === 'Keep' ? 'selected' : ''}" data-decision="Keep" data-item="${item.id}">‚úì Keep</button>
            <button class="decision-btn sell ${item.status === 'Sell' ? 'selected' : ''}" data-decision="Sell" data-item="${item.id}">üí∞ Sell</button>
            <button class="decision-btn donate ${item.status === 'Donate' ? 'selected' : ''}" data-decision="Donate" data-item="${item.id}">üéÅ Donate</button>
            <button class="decision-btn dump ${item.status === 'Dump' ? 'selected' : ''}" data-decision="Dump" data-item="${item.id}">üóëÔ∏è Dump</button>
          </div>

          ${item.status === 'Keep' ? `
            <input type="text" class="destination-input" placeholder="Where will it go? (e.g., Kitchen cabinet)"
                   value="${escapeHtml(item.destination || '')}" data-destination="${item.id}">
          ` : ''}
        </div>
      `}).join('');

      return `<div class="items-container">${itemCards}</div>`;
    }

    function renderModal() {
      return `
        <div class="modal-backdrop" onclick="closeForm()"></div>
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">Add Item</h2>
            <button class="modal-close" onclick="closeForm()">√ó</button>
          </div>

          <!-- Photo Upload -->
          <div class="form-group">
            <label class="form-label">üì∑ Add Photo ${GOOGLE_VISION_API_KEY ? '(AI will identify item)' : '(optional)'}</label>
            ${state.imagePreview ? `
              <div class="photo-preview-container">
                <img src="${state.imagePreview}" class="photo-preview" alt="Preview">
                <button class="photo-remove" onclick="removePhoto()">√ó</button>
              </div>
            ` : `
              <div class="photo-upload" onclick="triggerPhotoInput()">
                <div class="photo-upload-icon">üì∏</div>
                <div class="photo-upload-text">Tap to take photo or choose from gallery</div>
                <div class="photo-upload-hint">${GOOGLE_VISION_API_KEY ? 'ü§ñ AI will identify the item automatically' : 'Photo helps you remember the item'}</div>
              </div>
            `}
          </div>

          <!-- AI Suggestions -->
          ${state.aiLoading ? `
            <div class="ai-results">
              <div class="ai-loading">
                <div class="ai-spinner"></div>
                <span>ü§ñ Identifying item...</span>
              </div>
            </div>
          ` : ''}

          ${state.aiError ? `
            <div class="ai-results">
              <div class="ai-error">‚ö†Ô∏è ${escapeHtml(state.aiError)}</div>
              <div class="ai-skip" onclick="clearAI()">Skip AI and enter manually</div>
            </div>
          ` : ''}

          ${state.aiSuggestions && state.aiSuggestions.length > 0 ? `
            <div class="ai-results">
              <div class="ai-header">ü§ñ AI Suggestions (tap to use)</div>
              ${state.aiSuggestions.map((s, i) => `
                <div class="ai-suggestion" onclick="useAISuggestion(${i})">
                  <div class="ai-suggestion-name">${escapeHtml(s.name)}</div>
                  <div class="ai-suggestion-details">${s.confidence}% confidence ‚Ä¢ ${escapeHtml(s.category)}</div>
                </div>
              `).join('')}
              <div class="ai-skip" onclick="clearAI()">Skip suggestions and enter manually</div>
            </div>
          ` : ''}

          <div class="form-group">
            <label class="form-label">Item Name *</label>
            <input type="text" class="form-input" id="item-name" placeholder="e.g., Extra blender, Old desk lamp" value="${escapeHtml(state.newItem.name)}">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select class="form-select" id="item-category">
                ${CATEGORIES.map(cat => `<option value="${cat}" ${state.newItem.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Condition</label>
              <select class="form-select" id="item-condition">
                <option value="">Select...</option>
                <option value="Excellent" ${state.newItem.condition === 'Excellent' ? 'selected' : ''}>Excellent</option>
                <option value="Good" ${state.newItem.condition === 'Good' ? 'selected' : ''}>Good</option>
                <option value="Fair" ${state.newItem.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                <option value="Poor" ${state.newItem.condition === 'Poor' ? 'selected' : ''}>Poor</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Current Location</label>
              <input type="text" class="form-input" id="item-location" placeholder="e.g., Box 1" value="${escapeHtml(state.newItem.location)}">
            </div>
            <div class="form-group small">
              <label class="form-label">Est. Value $</label>
              <input type="number" class="form-input" id="item-value" placeholder="0" value="${escapeHtml(state.newItem.estimatedValue)}">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-textarea" id="item-description" placeholder="Brand, size, material, notable features..." rows="2">${escapeHtml(state.newItem.description)}</textarea>
          </div>

          <button class="submit-btn" id="submit-item" ${!state.newItem.name.trim() ? 'disabled' : ''}>Add Item</button>
          <p class="form-hint">Location stays selected for batch entry</p>
        </div>
      `;
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    function attachLoginEvents() {
      const btn = document.getElementById('google-signin');
      if (btn) {
        btn.addEventListener('click', signInWithGoogle);
      }
    }

    function attachEvents() {
      // Category filters
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          state.categoryFilter = chip.dataset.category;
          render();
        });
      });

      // Status filters
      document.querySelectorAll('.status-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          state.statusFilter = chip.dataset.status;
          render();
        });
      });

      // Decision buttons
      document.querySelectorAll('.decision-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          updateItem(btn.dataset.item, { status: btn.dataset.decision });
        });
      });

      // Destination inputs
      document.querySelectorAll('.destination-input').forEach(input => {
        input.addEventListener('blur', () => {
          updateItem(input.dataset.destination, { destination: input.value });
        });
      });

      // Delete buttons
      document.querySelectorAll('[data-delete]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('Delete this item?')) {
            deleteItem(btn.dataset.delete);
          }
        });
      });

      // Expand/collapse items
      document.querySelectorAll('[data-expand]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.dataset.expand;
          state.expandedItem = state.expandedItem === id ? null : id;
          render();
        });
      });

      // Form inputs
      const nameInput = document.getElementById('item-name');
      if (nameInput) {
        nameInput.focus();
        nameInput.addEventListener('input', (e) => {
          state.newItem.name = e.target.value;
          document.getElementById('submit-item').disabled = !e.target.value.trim();
        });
        nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSubmit(); });
      }

      const categorySelect = document.getElementById('item-category');
      if (categorySelect) {
        categorySelect.addEventListener('change', (e) => { state.newItem.category = e.target.value; });
      }

      const conditionSelect = document.getElementById('item-condition');
      if (conditionSelect) {
        conditionSelect.addEventListener('change', (e) => { state.newItem.condition = e.target.value; });
      }

      const locationInput = document.getElementById('item-location');
      if (locationInput) {
        locationInput.addEventListener('input', (e) => { state.newItem.location = e.target.value; });
      }

      const valueInput = document.getElementById('item-value');
      if (valueInput) {
        valueInput.addEventListener('input', (e) => { state.newItem.estimatedValue = e.target.value; });
      }

      const descInput = document.getElementById('item-description');
      if (descInput) {
        descInput.addEventListener('input', (e) => { state.newItem.description = e.target.value; });
      }

      // Form submit
      const submitBtn = document.getElementById('submit-item');
      if (submitBtn) {
        submitBtn.addEventListener('click', handleSubmit);
      }
    }

    // Photo handling
    function triggerPhotoInput() {
      document.getElementById('photo-input').click();
    }

    function removePhoto() {
      state.selectedImage = null;
      state.imagePreview = null;
      state.aiLoading = false;
      state.aiError = null;
      state.aiSuggestions = null;
      document.getElementById('photo-input').value = '';
      render();
    }

    function clearAI() {
      state.aiLoading = false;
      state.aiError = null;
      state.aiSuggestions = null;
      render();
    }

    function useAISuggestion(index) {
      if (!state.aiSuggestions || !state.aiSuggestions[index]) return;

      const suggestion = state.aiSuggestions[index];
      state.newItem.name = suggestion.name;
      state.newItem.category = suggestion.category;
      state.aiSuggestions = null;
      state.aiError = null;
      render();

      // Focus on the location field since name and category are filled
      setTimeout(() => {
        const locationInput = document.getElementById('item-location');
        if (locationInput) locationInput.focus();
      }, 100);
    }

    document.getElementById('photo-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Show preview immediately
      state.imagePreview = URL.createObjectURL(file);
      state.aiLoading = GOOGLE_VISION_API_KEY ? true : false;
      state.aiError = null;
      state.aiSuggestions = null;
      render();

      try {
        // Compress image
        state.selectedImage = await compressImage(file);

        // Try AI identification if API key is configured
        if (GOOGLE_VISION_API_KEY) {
          try {
            const suggestions = await identifyItemWithAI(state.selectedImage);
            state.aiSuggestions = suggestions;
            state.aiLoading = false;
            render();
          } catch (aiError) {
            console.error('AI error:', aiError);
            state.aiLoading = false;
            state.aiError = 'Could not identify item. Please enter details manually.';
            render();
          }
        }
      } catch (error) {
        console.error('Error processing image:', error);
        alert('Could not process image. Please try again.');
        removePhoto();
      }
    });

    async function handleSubmit() {
      const name = state.newItem.name.trim();
      if (!name) return;

      // Disable button to prevent double submit
      const btn = document.getElementById('submit-item');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Adding...';
      }

      await addItem({
        name: name,
        category: state.newItem.category,
        location: state.newItem.location.trim() || 'Unassigned',
        condition: state.newItem.condition,
        estimatedValue: state.newItem.estimatedValue,
        description: state.newItem.description,
        status: 'To Sort'
      });

      // Reset form but keep location
      const savedLocation = state.newItem.location;
      state.newItem = {
        name: '',
        category: 'Kitchen Items',
        location: savedLocation,
        condition: '',
        estimatedValue: '',
        description: ''
      };
      state.selectedImage = null;
      state.imagePreview = null;
      state.showForm = false;
      render();
    }

    function openForm() {
      state.showForm = true;
      render();
    }

    function closeForm() {
      state.showForm = false;
      state.selectedImage = null;
      state.imagePreview = null;
      state.aiLoading = false;
      state.aiError = null;
      state.aiSuggestions = null;
      render();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // ============================================
    // INIT
    // ============================================
    auth.onAuthStateChanged(async (user) => {
      state.user = user;
      state.loading = false;
      if (user) {
        await loadItems();
      } else {
        state.items = [];
      }
      render();
    });
  </script>
</body>
</html>
